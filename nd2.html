<!DOCTYPE HTML>
<html>
	<head>
		<title>nativeDroid II - jQueryMobile Template</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css" />
		<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.5/jquery.mobile.min.css" />
		<link rel="stylesheet" href="vendor/waves/waves.min.css" />
		<link rel="stylesheet" href="vendor/wow/animate.css" />
		<link rel="stylesheet" href="css/nativedroid2.css" />

		<meta name="mobile-web-app-capable" content="yes">
	 	<meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />

	</head>
	<body>

		<div data-role="page">

			<div data-role="header" data-position="fixed" class="wow fadeInDown" data-wow-delay="0.2s">
				<a href="#bottomsheet" class="ui-btn ui-btn-right wow fadeIn" data-wow-delay='1.2s'><i class="zmdi zmdi-more-vert"></i></a>
				<a href="#leftpanel" class="ui-btn ui-btn-left wow fadeIn" data-wow-delay='0.8s'><i class="zmdi zmdi-menu"></i></a>
				<h1 class="wow fadeIn" data-wow-delay='0.4s'>Page Title</h1>
			</div>
			<a id="start" href="#" class="ui-btn ui-btn-icon-left"><i class='zmdi zmdi-plus'></i> Start</a>
			<div role="main" class="ui-content" data-inset="false">
				<svg id="graphB" width="400" height="100"></svg>
				<svg id="graphG" width="400" height="100"></svg>
				<svg id="graphA" width="400" height="100"></svg>
			</div>
			<div>
				<div id="maxA"><span class="l">Max Alpha: </span><span class="v"></span> [<span class="d"></span>]</div>
				<div id="maxB"><span class="l">Max Beta: </span><span class="v"></span> [<span class="d"></span>]</div>
				<div id="maxG"><span class="l">Max Gamma: </span><span class="v"></span> [<span class="d"></span>]</div>
			</div>
			<div id="log" />

		</div>
		<style>
			/* tell the SVG path to be a thin blue line without any area fill */
			path {
				stroke-width: 1;
				fill: none;
			}
			
			.dataA {
				stroke: steelblue;
			}

			.dataB {
				stroke: orange;
			}

			.dataG {
				stroke: green;
			}

			.axis {
			  shape-rendering: crispEdges;
			}

			.x.axis line {
			  stroke: lightgrey;
			}

			.x.axis .minor {
			  stroke-opacity: .5;
			}

			.x.axis path {
			  display: none;
			}
			
			.x.axis text {
				font-size: 14;
			}

			.y.axis line, .y.axis path {
			  fill: none;
			  stroke: #000;
			}

			.y.axis text {
				font-size: 14;
			}

			.y.axisRight text {
				fill: orange;
			}
			
			.y.axisLeft text {
				fill: steelblue;
			}
		</style>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
		<script src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.5/jquery.mobile.min.js"></script>
		<script src="vendor/chartist/chartist.min.js"></script>
		<script src="vendor/waves/waves.min.js"></script>
		<script src="vendor/wow/wow.min.js"></script>
		<script src="js/nativedroid2.js"></script>
		<script src="nd2settings.js"></script>
		<script src="https://d3js.org/d3.v3.min.js"></script>

		<script>
    $(document).bind('mobileinit',function(){
        $.mobile.changePage.defaults.changeHash = false;
        $.mobile.hashListeningEnabled = false;
        $.mobile.pushStateEnabled = false;
    });



function populateGraph(graph, label, data, range, showLine, showAxis)
{	
		// define dimensions of graph
		var m = [80, 80, 80, 80]; // margins
		var w = 400 - m[1] - m[3];	// width
		var h = 100 - m[0] - m[2]; // height

		var x     = d3.scale.linear().domain([0, dataA.length]).range([0, w]);
		var y   = d3.scale.linear().domain([ -1*range,  range]).range([h, 0]); 
			
		var d3l = d3.svg.line()
			.x(function(d,i) { return x(i); })
			.y(function(d)   { return y(d); });
		
		// Add an SVG element with the desired dimensions and margin.
		var graph = d3.select(graph).append("svg:svg")
		      .attr("width", w + m[1] + m[3])
		      .attr("height", h + m[0] + m[2])
		      .append("svg:g")
		      .attr("transform", "translate(" + m[3] + "," + m[0] + ")");

		if (showAxis)
		{
			var xAxis = d3.svg.axis().scale(x).tickSize(-h).tickSubdivide(true);
			graph.append("svg:g")
			      .attr("class", "x axis")
			      .attr("transform", "translate(0," + h + ")")
			      .call(xAxis);
		}


		if (showLine)
			graph.append("svg:path").attr("d", d3l(data)).attr("class", label);
		else
			graph.selectAll("dot")
	        	.data(data)
	      		.enter().append("circle")
	      	        .attr("r", 0.7)
	        		.attr("cx", function(d, i) { return x(i); })
	       			.attr("cy", function(d) { return y(d); });
		
}

function mkGraph()
{	
		// define dimensions of graph
		var m = [80, 80, 80, 80]; // margins
		var w = 400 - m[1] - m[3];	// width
		var h = 100 - m[0] - m[2]; // height

		var x     = d3.scale.linear().domain([0, dataA.length]).range([0, w]);
		var y90   = d3.scale.linear().domain([ -90,  90]).range([h, 0]); 
		var y180  = d3.scale.linear().domain([-180, 180]).range([h, 0]);  
			
		// create a line function that can convert data[] into x and y points
		var line90 = d3.svg.line()
			.x(function(d,i) { return x(i); })
			.y(function(d) { return y90(d); });
		var line180 = d3.svg.line()
			.x(function(d,i) { return x(i); })
			.y(function(d) { return y180(d); });
		
		// Add an SVG element with the desired dimensions and margin.
		var graph = d3.select("#graph").append("svg:svg")
		      .attr("width", w + m[1] + m[3])
		      .attr("height", h + m[0] + m[2])
		      .append("svg:g")
		      .attr("transform", "translate(" + m[3] + "," + m[0] + ")");

		// create yAxis
		var xAxis = d3.svg.axis().scale(x).tickSize(-h).tickSubdivide(true);
		// Add the x-axis.
		graph.append("svg:g")
		      .attr("class", "x axis")
		      .attr("transform", "translate(0," + h + ")")
		      .call(xAxis);

		// add lines
		// do this AFTER the axes above so that the line is above the tick-lines
		//graph.append("svg:path").attr("d", line180(dataA)).attr("class", "dataA");
		graph.append("svg:path").attr("d", line180(dataB)).attr("class", "dataB");
		graph.append("svg:path").attr("d", line90(dataG)).attr("class", "dataG");

		graph.selectAll("dot")
        	.data(dataA)
      		.enter().append("circle")
      	        .attr("r", 0.7)
        		.attr("cx", function(d, i) { return x(i); })
       			.attr("cy", function(d) { return y180(d); });
		
}

var dataA = [];
var dataB = [];
var dataG = [];
var maxB = { v: 0, d: null };
var maxG = { v: 0, d: null };

function setMax(key, maxV, v, d) {
	if (Math.abs(v) > maxV.v) { 
		maxV.v = Math.abs(v); 
		maxV.d=d;
		$(key + ' span.v').text(Math.round(maxV.v));
    	$(key + ' span.d').text(Math.round(maxV.d));
    }
}

function deviceOrientationListener(event) {
	 var m = {};
	 var alpha = (alpha > 180) ? alpha-360 : alpha;
     m.dir=event.alpha; // -180 = +180
     m.tilt=event.beta; // -180 = +180
     m.yaw=event.gamma; // - 90 - + 90
     m.count = dataA.length;
     dataA.push(event.alpha);
     dataB.push(event.beta);
     dataG.push(event.gamma);

     setMax("#maxB", maxB, event.beta, event.alpha);
     setMax("#maxG", maxG, event.gamma, event.alpha);
     setMax("#maxA", maxA, event.alpha, event.alpha);

     if (m.count==400)
     {
		window.removeEventListener("deviceorientation", deviceOrientationListener);
        populateGraph("#graphB", "dataB", dataB, 180, true,  true);
        populateGraph("#graphG", "dataG", dataG,  90, true,  true);
        populateGraph("#graphA", "dataA", dataA, 180, false, true);
     }
     //$("#log").append("<p>Event: D="+dir+", T="+tilt+", Y="+yaw+"</p>");
}

$('#start').click(function() {
	dataA = [];
	dataB = [];
	dataG = [];
	maxB = { v: 0, d: null };
	maxG = { v: 0, d: null };
	maxA = { v: 0, d: null };
	window.addEventListener("deviceorientation", deviceOrientationListener);
});

</script> 

	</body>
</html>
