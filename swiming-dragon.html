<!DOCTYPE HTML>
<html>
	<head>
		<title>nativeDroid II - jQueryMobile Template</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css" />
		<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.5/jquery.mobile.min.css" />
		<link rel="stylesheet" href="vendor/waves/waves.min.css" />
		<link rel="stylesheet" href="vendor/wow/animate.css" />
		<link rel="stylesheet" href="css/nativedroid2.css" />


		<meta name="mobile-web-app-capable" content="yes">
	 	<meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />

	</head>
	<body>

		<div data-role="page">
			<div role="main" class="ui-content" data-inset="false">
				<div id="gB" class="graph-holder"><div></div></svg></div>
				<div id="gG" class="graph-holder"><div></div></svg></div>
				<div id="gA" class="graph-holder"><div></div></svg></div>
				<div id="xx" class="graph-holder"><div></div></div>
			</div>
		</div>
		<style>
		.graph-holder {
		  position: relative;
		  width: 340px;
		  height: 90px;
  		  border: 0px solid #c00;
		}
		.graph-holder svg {	
  			position: absolute;
			top: 0px;
  			left: 0px;
		}
		.graph-holder div {	
  			position: absolute;
			top: 0;
    		bottom: 0;
			left: 0;
    		right: 0;
    		margin: auto;
    		text-align: center;
    		font-size: 4em;
    		color: #cccccc;
		}
			/* tell the SVG path to be a thin blue line without any area fill */
			path {
				stroke-width: 1;
				fill: none;
			}
			
			.dataA {
				stroke: steelblue;
			}

			.dataB {
				stroke: orange;
			}

			.dataG {
				stroke: green;
			}

			.axis {
			  shape-rendering: crispEdges;
			}

			.x.axis line {
			  stroke: lightgrey;
			}

			.x.axis .minor {
			  stroke-opacity: .5;
			}

			.x.axis path {
			  display: none;
			}
			
			.x.axis text {
				font-size: 14;
			}

			.y.axis line, .y.axis path {
			  fill: none;
			  stroke: #000;
			}

			.y.axis text {
				font-size: 14;
			}

			.y.axisRight text {
				fill: orange;
			}
			
			.y.axisLeft text {
				fill: steelblue;
			}

			#graphB .axis text { display: none; }
			#graphG .axis text { display: none; }
			div.ui-content { padding: 0;}
		</style>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
		<script src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.5/jquery.mobile.min.js"></script>
		<script src="vendor/chartist/chartist.min.js"></script>
		<script src="vendor/waves/waves.min.js"></script>
		<script src="vendor/wow/wow.min.js"></script>
		<script src="js/nativedroid2.js"></script>
		<script src="nd2settings.js"></script>
		<script src="https://d3js.org/d3.v3.min.js"></script>

		<script src="howler2.js"></script>
		<script src="NoSleep.js"></script>

		<script>
    $(document).bind('mobileinit',function(){
        $.mobile.changePage.defaults.changeHash = false;
        $.mobile.hashListeningEnabled = false;
        $.mobile.pushStateEnabled = false;
    });


function popCircle(graph, label, data, range, showLine, showAxis)
{
	var m = [0, 5, 15, 5]; // margins
	if (range == null)
	{
		var mx = Math.max.apply(null, data);
		var mn = Math.min.apply(null, data);
		range = Math.max(mx, -1*mn)*1.1;
		m = [0, 5, 0, 5];
	}

	// define dimensions of graph
	
	var w = 340 - m[1] - m[3];	// width
	var h = 340 - m[0] - m[2]; // height

	var x   = d3.scale.linear().domain([0, dataA.length]).range([0, w]);
	var y   = d3.scale.linear().domain([ -1*range,  range]).range([h, 0]); 
	

	var cX=function(d) { 
		r=((d.b+20)/40) * 20 + 20;
		t=d.a/360*Math.PI;
		return Math.cos(t) * r + 60;}

	var cY=function(d) { 
		r=((d.b+20)/40) * 20 + 20;
		t=d.a/360*Math.PI;
		return Math.sin(t) * r + 60;}
	var d3l = d3.svg.line()
		.x(cX)
		.y(cY);

	var graph = d3.select(graph).append("svg:svg")
		      .attr("width", w + m[1] + m[3])
		      .attr("height", h + m[0] + m[2])
		      .append("svg:g")
		      .attr("transform", "translate(" + m[3] + "," + m[0] + ")");

	graph.append("svg:path").attr("d", d3l(data)).attr("class", label);

}

function populateGraph(graph, label, data, range, showLine, showAxis)
{	
		var m = [0, 5, 15, 5]; // margins
		if (range == null)
		{
			var mx = Math.max.apply(null, data);
			var mn = Math.min.apply(null, data);
			range = Math.max(mx, -1*mn)*1.1;
			m = [0, 5, 0, 5];
		}

		// define dimensions of graph
		
		var w = 340 - m[1] - m[3];	// width
		var h = 90 - m[0] - m[2]; // height

		var x   = d3.scale.linear().domain([0, dataA.length]).range([0, w]);
		var y   = d3.scale.linear().domain([ -1*range,  range]).range([h, 0]); 
		var d3l = d3.svg.line()
			.x(function(d,i) { return x(i); })
			.y(function(d)   { return y(d); });
		
		
		// Add an SVG element with the desired dimensions and margin.
		var graph = d3.select(graph).append("svg:svg")
		      .attr("width", w + m[1] + m[3])
		      .attr("height", h + m[0] + m[2])
		      .append("svg:g")
		      .attr("transform", "translate(" + m[3] + "," + m[0] + ")");

		if (showAxis)
		{
			var xAxis = d3.svg.axis().scale(x).tickSize(-h).tickSubdivide(true);
			graph.append("svg:g")
			      .attr("class", "x axis")
			      .attr("transform", "translate(0," + h + ")")
			      .call(xAxis);
		}


		if (showLine)
			graph.append("svg:path").attr("d", d3l(data)).attr("class", label);
		else
			graph.selectAll("dot")
	        	.data(data)
	      		.enter().append("circle")
	      	        .attr("r", 0.7)
	        		.attr("cx", function(d, i) { return x(i); })
	       			.attr("cy", function(d) { return y(d); });


		
}

var date = new Date();
var start = 0;
var data = [];
var dataA = [];
var dataB = [];
var dataG = [];
var maxB = { v: 0, d: null };
var maxG = { v: 0, d: null };
var sound = new Audio("music/ting.wav");

function setMax(key, maxV, v, d) {
	if (Math.abs(v) > maxV.v) { 
		maxV.v = Math.abs(v); 
		maxV.d=d;
		$(key + ' div').text(Math.round(maxV.v));
    	//$(key + ' span.d').text(Math.round(maxV.d));
    }
}

function deviceOrientationListener(event) {
	 var alpha = (event.alpha > 180) ? event.alpha-360 : event.alpha;
     dataA.push(alpha);
     dataB.push(event.beta);
     dataG.push(event.gamma);

     var count=data.length;
     var d = { a:alpha, b: event.beta, g:event.gamma, n: count };
     data.push(d);

     setMax("#gB", maxB, event.beta, alpha);
     setMax("#gG", maxG, event.gamma, alpha);
     //setMax("#maxA", maxA, event.alpha, alpha);

}

function startListener() {
	console.log("START");
	sound.play();
	dataA = [];
	dataB = [];
	dataG = [];
	maxB = { v: -1, d: null };
	maxG = { v: -1, d: null };
	maxA = { v: 0, d: null };

    setMax("#gB", maxB, 0, 0);
    setMax("#gG", maxG, 0, 0);
	window.addEventListener("deviceorientation", deviceOrientationListener);
}

function stopListener() {
	console.log("STOP");
	sound.play();
	window.removeEventListener("deviceorientation", deviceOrientationListener);
    populateGraph("#gB", "dataB", dataB, null, true,  true);
    populateGraph("#gG", "dataG", dataG, null, true,  true);
    populateGraph("#gA", "dataA", dataA, 180, false, true);
    popCircle("#xx", "dataA", data, 180, true, true);
}

$(document).ready(function() {
	console.log("INIT");	
	sound = new Howl({ src: ["music/ting.wav"], volume: 1.0});
	
	var s=1000;
	//s=100;
	window.setTimeout(
		function() { 
			$('.ui-content').css('background-color', 'white');
			startListener();
			window.setTimeout(function() { stopListener(); }, 30*s);
		}, 4*s);
});
</script> 

	</body>
</html>
